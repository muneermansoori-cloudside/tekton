apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: build-and-push
spec:
  params:
    - name: repo-url
      type: string
    - name: image-name
      type: string
    - name: image-tag
      type: string
      default: latest
  steps:
    - name: git-source
      image: alpine/git
      workingDir: /workspace/source
      command:
        - sh
      args:
        - -c
        - |
          git clone $(params.repo-url) 
    - name: client
      image: docker
      
      env:
      # Connect to the sidecar over TCP, with TLS.
      - name: DOCKER_HOST
        value: tcp://localhost:2376
      # Verify TLS.
      - name: DOCKER_TLS_VERIFY
        value: '1'
      # Use the certs generated by the sidecar daemon.
      - name: DOCKER_CERT_PATH
        value: /certs/client
      workingDir: /workspace/source
      script: |
          #!/usr/bin/env sh
          set -e
          cd simple-dockerfile
          docker build -t my-image-1 .
          docker tag my-image-1 muneer16/testing-repo
          docker login -u muneer16 -p C0m@n-pass
          docker push muneer16/testing-repo
          docker images

      volumeMounts:
      - mountPath: /certs/client
        name: dind-certs
    - name: run-kubectl
      image: lachlanevenson/k8s-kubectl
      workingDir: /workspace/source
      command: ["kubectl"]
      args:
        - "apply"
        - "-f"
        - "./simple-dockerfile/deploy.yaml"

  sidecars:
  - image: docker:dind
    name: server
    args:
      - --storage-driver=vfs
      - --userland-proxy=false
      - --debug
  #    computeResources:
  #      requests:
  #        memory: "512Mi"
    securityContext:
      privileged: true
    env:
    # Write generated certs to the path shared with the client.
    - name: DOCKER_TLS_CERTDIR
      value: /certs
    volumeMounts:
    - mountPath: /certs/client
      name: dind-certs
     # Wait for the dind daemon to generate the certs it will share with the
      # client.
    readinessProbe:
     periodSeconds: 1
     exec:
        command: ['ls', '/certs/client/ca.pem']
  volumes:
  - name: dind-certs
    emptyDir: {}
